<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solarwind - ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏ä‡∏∏‡∏î</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles from original index.html, adapted for Inter font */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8F8F8; /* Very light grey/off-white for background */
            color: #222222; /* Darker black for default text */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Use min-height to ensure full height, but allow content to expand */
            margin: 0;
            padding: 1rem; /* Add some padding for smaller screens */
            box-sizing: border-box;
        }
        .container {
            background-color: #FFFFFF; /* Pure white for the main container */
            padding: 2.5rem;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15); /* Stronger shadow */
            width: 100%;
            max-width: 700px; /* Adjusted max-width to fit more content */
            text-align: center;
            border: 1px solid #E0E0E0; /* Subtle border */
            max-height: 95vh; /* Limit height */
            overflow-y: auto; /* Enable scrolling for overflow */
        }
        h1 { /* Changed from h2 in template to h1 from original index.html */
            color: #FFD700; /* Bright Gold/Yellow for main heading */
            font-size: 2.25rem; /* Tailwind h2 size */
            font-weight: 700; /* Tailwind bold */
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); /* Subtle text shadow for depth */
        }
        h1 svg { /* Styling for the SVG icon next to the heading */
            width: 2.5rem;
            height: 2.5rem;
            color: #FFD700;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        input[type="file"] {
            display: none; /* Hide default file input */
        }
        /* Custom file upload label styling */
        .file-upload-label {
            background-color: #FFD700; /* Bright Gold/Yellow */
            color: #222222; /* Darker black text on yellow */
            padding: 12px 20px;
            border-radius: 0.75rem; /* More rounded */
            cursor: pointer;
            display: inline-block;
            transition: background-color 0.3s, transform 0.2s;
            font-weight: 600; /* Semi-bold */
            box-shadow: 0 4px 10px rgba(255, 215, 0, 0.3); /* Yellow shadow */
        }
        .file-upload-label:hover {
            background-color: #FFC400; /* Slightly darker yellow on hover */
            transform: translateY(-2px); /* Lift effect on hover */
        }
        #file-name {
            margin-top: 10px;
            color: #444444; /* Dark grey for file name */
            font-size: 1rem;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
        }
        button {
            border: none;
            padding: 12px 24px;
            border-radius: 0.75rem; /* Consistent border-radius */
            cursor: pointer;
            font-size: 1.1rem;
            transition: background-color 0.3s, transform 0.2s;
            flex-grow: 1; /* Allow buttons to grow */
            max-width: 200px; /* Limit individual button width */
            color: #FFFFFF; /* White text for all primary buttons */
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); /* Subtle shadow for buttons */
        }
        #submit-button {
            background-color: #4CAF50; /* Green for submit */
        }
        #submit-button:hover:not([disabled]) {
            background-color: #43A047;
            transform: translateY(-2px);
        }
        #cancel-button {
            background-color: #F44336; /* Red for cancel */
            display: none;
        }
        #cancel-button:hover:not([disabled]) {
            background-color: #D32F2F;
            transform: translateY(-2px);
        }
        #download-button {
            background-color: #03A9F4; /* Blue for download */
            display: none;
        }
        #download-button:hover:not([disabled]) {
            background-color: #0288D1;
            transform: translateY(-2px);
        }
        button[disabled] {
            background-color: #AAAAAA; /* Grey for disabled */
            cursor: not-allowed;
            transform: none;
            box-shadow: none; /* No shadow when disabled */
        }

        /* Status and Progress Area */
        #status-area {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #FFF8DC; /* Cornsilk (very light yellow) */
            border: 1px solid #FFD700; /* Gold border */
            border-radius: 8px;
            display: none;
            text-align: left;
            color: #333333; /* Dark grey for status text */
        }
        #status-message {
            font-size: 1.2rem;
            color: #B8860B; /* Darker goldenrod for status message */
            margin-bottom: 1rem;
            font-weight: bold;
        }
        .progress-container {
            width: 100%;
            background-color: #E0E0E0;
            border-radius: 0.5rem; /* Consistent with other elements */
            overflow: hidden;
            height: 1.5rem;
            margin-top: 1rem;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); /* Inner shadow for depth */
        }
        .progress-bar { /* Renamed from .progress-bar-fill for consistency */
            height: 100%;
            width: 0%;
            background-color: #FFD700; /* Bright Gold/Yellow for progress */
            transition: width 0.3s ease;
            text-align: center;
            color: #222222; /* Darker black text on progress bar */
            line-height: 1.5rem; /* Vertically center text */
            font-weight: 600; /* Semi-bold */
            font-size: 0.875rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            border-radius: 0.5rem; /* Apply border-radius to the fill */
        }
        #progress-text {
            margin-top: 10px;
            color: #555555; /* Medium grey for progress text */
            font-size: 1rem;
        }

        /* Log Area */
        #log-area {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #000000; /* Black background for log area */
            border: 1px solid #333333; /* Dark grey border for log */
            border-radius: 0.75rem; /* More rounded */
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            text-align: left;
            word-break: break-all;
            color: #EEEEEE; /* Light grey for default log text */
        }
        #log-area div {
            margin-bottom: 2px;
        }
        /* Log message colors for dark background */
        .log-success { color: #8BC34A; } /* Lighter green */
        .log-error { color: #FF7043; } /* Lighter red/orange */
        .log-warning { color: #FFEB3B; } /* Bright yellow */
        .log-info { color: #64B5F6; } /* Lighter blue */
        .log-critical { color: #EF5350; font-weight: bold; } /* Brighter red */

        /* Results Area */
        #results-area {
            margin-top: 2rem;
            display: none;
            text-align: left;
            color: #222222; /* Dark black for results text */
        }
        #summary-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        #summary-list li {
            margin-bottom: 5px;
        }
        .status-icon {
            font-weight: bold;
            font-size: 1.5em;
            vertical-align: middle;
        }
        .success-icon {
            color: #4CAF50; /* Green */
        }
        .failure-icon {
            color: #F44336; /* Red */
        }
        .warning-icon {
            color: #FF9800; /* Orange */
        }

        /* Styling for the note area */
        .note {
            font-size: 0.875rem;
            color: #6B7280;
            text-align: left;
            width: 100%;
            margin-top: -1rem;
            margin-bottom: 1rem;
            background-color: #f0f4f8;
            border-left: 4px solid #3B82F6;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19.5 9.75a.75.75 0 0 0-.75.75v4.5a.75.75 0 0 0 .75.75h2.25a.75.75 0 0 0 .75-.75V10.5a.75.75 0 0 0-.75-.75h-2.25Z" />
            <path fill-rule="evenodd" d="M12 2.25A2.25 2.25 0 0 0 9.75 0H5.25A2.25 2.25 0 0 0 3 2.25V9a2.25 2.25 0 0 0 2.25 2.25h4.5A2.25 2.25 0 0 0 12 9V2.25ZM12 12.75A2.25 2.25 0 0 0 9.75 10.5H5.25A2.25 2.25 0 0 0 3 12.75v6.75A2.25 2.25 0 0 0 5.25 21h4.5A2.25 2.25 0 0 0 12 18.75v-6.75Z" clip-rule="evenodd" />
            <path d="M15 2.25a.75.75 0 0 0-.75.75V7.5a.75.75 0 0 0 .75.75h2.25a.75.75 0 0 0 .75-.75V3a.75.75 0 0 0-.75-.75H15Z" />
            <path d="M15 12.75a.75.75 0 0 0-.75.75v4.5a.75.75 0 0 0 .75.75h2.25a.75.75 0 0 0 .75-.75v-4.5a.75.75 0 0 0-.75-.75H15Z" />
        </svg>
        Solarwind
    </h1>
    <div class="form-group">
        <form id="upload-form"> <label for="excel_file" class="text-left w-full block mb-2">‡πÑ‡∏ü‡∏•‡πå Excel (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Node):</label>
            <div class="note">
                <p>‚ö†Ô∏è **‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:** ‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ: **Node Name**, **NodeID**, **Interface ID**, **‡∏Å‡∏£‡∏∞‡∏ó‡∏£‡∏ß‡∏á / ‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î**, **‡∏Å‡∏£‡∏° / ‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î**, **‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î**, **‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô**</p>
            </div>
            <input type="file" id="excel_file" name="excel_file" accept=".xlsx, .xls" required>
            <label for="excel_file" class="file-upload-label">
                ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel
            </label>
            <div id="file-name">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</div>
        </form>
    </div>
    <div class="button-group">
        <button id="submit-button" type="submit" form="upload-form" disabled>Export File</button>
        <button id="cancel-button">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button id="download-button" disabled>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (ZIP)</button>
    </div>
    
    <div id="status-area">
        <div id="status-message"></div>
        <div class="progress-container">
            <div id="progress-bar" class="progress-bar"></div> </div>
        <div id="progress-text"></div>
        <div id="log-area"></div>
    </div>

    <div id="results-area">
        <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£Export</h3>
        <ul id="summary-list">
        </ul>
    </div>
</div>

<script>
    const form = document.getElementById('upload-form');
    const fileInput = document.getElementById('excel_file');
    const submitButton = document.getElementById('submit-button');
    const cancelButton = document.getElementById('cancel-button');
    const downloadButton = document.getElementById('download-button');
    const fileNameDisplay = document.getElementById('file-name');
    const statusArea = document.getElementById('status-area');
    const statusMessage = document.getElementById('status-message');
    const progressBar = document.getElementById('progress-bar'); // Updated ID
    const progressText = document.getElementById('progress-text');
    const logArea = document.getElementById('log-area');
    const resultsArea = document.getElementById('results-area');
    const summaryList = document.getElementById('summary-list');
    
    let statusIntervalId;
    let logIntervalId;
    let currentJobId = null;

    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            fileNameDisplay.textContent = fileInput.files[0].name;
            submitButton.disabled = false;
        } else {
            fileNameDisplay.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå';
            submitButton.disabled = true;
        }
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        statusArea.style.display = 'none';
        resultsArea.style.display = 'none';
        downloadButton.style.display = 'none';
        downloadButton.disabled = true;
        cancelButton.style.display = 'none';
        summaryList.innerHTML = '';
        logArea.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á log ‡πÄ‡∏Å‡πà‡∏≤
        clearIntervals(); // ‡∏´‡∏¢‡∏∏‡∏î interval ‡πÄ‡∏Å‡πà‡∏≤‡∏´‡∏≤‡∏Å‡∏°‡∏µ
    });

    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        
        const file = fileInput.files[0];
        if (!file) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡πà‡∏≠‡∏ô');
            return;
        }

        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï UI ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
        submitButton.disabled = true;
        cancelButton.style.display = 'inline-block';
        cancelButton.disabled = false;
        downloadButton.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
        downloadButton.disabled = true;
        
        statusArea.style.display = 'block';
        resultsArea.style.display = 'none';
        statusMessage.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';
        progressBar.style.width = '0%';
        progressBar.textContent = '';
        progressText.textContent = '';
        summaryList.innerHTML = '';
        logArea.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á log ‡πÄ‡∏Å‡πà‡∏≤
        clearIntervals(); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏´‡∏¢‡∏∏‡∏î interval ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß

        const formData = new FormData();
        formData.append('excel_file', file);

        try {
            const response = await fetch('/generate_report', { // API endpoint from original index.html
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Server returned an error');
            }

            const data = await response.json();
            currentJobId = data.job_id; // Matches original index.html's job_id

            statusMessage.innerHTML = `‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå <b>${file.name}</b> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß...`;

            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            statusIntervalId = setInterval(fetchStatus, 1000);
            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏∂‡∏á Log
            logIntervalId = setInterval(fetchLogs, 500);

        } catch (error) {
            statusMessage.innerHTML = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ${error.message}`;
            progressBar.style.width = '0%';
            progressBar.textContent = '';
            progressText.textContent = '';
            submitButton.disabled = false;
            cancelButton.style.display = 'none';
            downloadButton.style.display = 'none';
            clearIntervals();
        }
    });

    cancelButton.addEventListener('click', async () => {
        if (currentJobId) {
            cancelButton.disabled = true;
            statusMessage.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å...';
            try {
                const response = await fetch(`/cancel/${currentJobId}`, { method: 'POST' });
                if (response.ok) {
                    console.log('Cancel request sent successfully');
                    // fetchStatus ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ 'canceled'
                } else {
                    const errorData = await response.json();
                    statusMessage.innerHTML = `‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ: ${errorData.error || 'Unknown error'}`;
                    cancelButton.disabled = false;
                }
            } catch (error) {
                statusMessage.innerHTML = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å: ' + error.message;
                cancelButton.disabled = false;
            }
        }
    });

    downloadButton.addEventListener('click', () => {
        if (currentJobId) {
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
            window.location.href = `/download_report/${currentJobId}`; // API endpoint from original index.html
            // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á disabled ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ
            // ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô statusMessage ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
        }
    });

    function clearIntervals() {
        if (statusIntervalId) {
            clearInterval(statusIntervalId);
            statusIntervalId = null;
        }
        if (logIntervalId) {
            clearInterval(logIntervalId);
            logIntervalId = null;
        }
        cancelButton.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
    }

    async function fetchStatus() {
        if (!currentJobId) return;

        try {
            const statusResponse = await fetch(`/status/${currentJobId}`); // API endpoint from original index.html
            const statusData = await statusResponse.json();

            if (statusData.error) {
                statusMessage.innerHTML = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${statusData.error}`;
                progressBar.style.width = '0%';
                progressBar.textContent = '';
                progressText.textContent = '';
                clearIntervals();
                submitButton.disabled = false;
                downloadButton.style.display = 'none';
                return;
            }

            if (statusData.canceled) {
                statusMessage.innerHTML = '‚õî ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
                progressBar.style.width = '0%';
                progressBar.textContent = '';
                progressText.textContent = '';
                clearIntervals();
                submitButton.disabled = false;
                downloadButton.style.display = 'none';
                return;
            }

            if (statusData.total > 0) {
                const processed = statusData.processed;
                const total = statusData.total;
                const percentage = (processed / total) * 100;
                
                progressBar.style.width = `${percentage}%`;
                progressBar.textContent = `${Math.round(percentage)}%`;
                progressText.textContent = `‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß ${processed} ‡∏à‡∏≤‡∏Å ${total} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

                if (statusData.completed) {
                    statusMessage.innerHTML = '‚úÖ Export‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!';
                    clearIntervals();
                    submitButton.disabled = false;
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡∏°‡∏µ zip_file_path
                    if (statusData.zip_file_path) {
                        downloadButton.style.display = 'inline-block';
                        downloadButton.disabled = false; // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ
                    } else {
                        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå ZIP (‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á ZIP)
                        downloadButton.style.display = 'none';
                        downloadButton.disabled = true;
                        statusMessage.innerHTML += '<br><span style="color:red; font-size:0.9em;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå ZIP ‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Log ‡∏´‡∏£‡∏∑‡∏≠ Terminal</span>';
                    }

                    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•
                    let csvSuccessCount = 0;
                    let csvFailedFiles = [];
                    let pdfSuccessCount = 0;
                    let pdfFailedFiles = [];
                    let skipCount = 0;
                    
                    if (statusData.results && statusData.results.length > 0) {
                        statusData.results.forEach(result => {
                            if (result.error_message === "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• NodeID ‡∏´‡∏£‡∏∑‡∏≠ Interface ID ‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå") {
                                skipCount++;
                            } else {
                                if (result.csv_success) {
                                    csvSuccessCount++;
                                } else {
                                    const identifier = (result.node_name && result.node_name.includes('_') && result.node_name.split('_').length >= 3) ? 
                                        `(${result.node_name.split('_').slice(-2).join('/')})` : 
                                        '';
                                    csvFailedFiles.push(`${result.node_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'} ${identifier}`);
                                }
                                if (result.pdf_success) {
                                    pdfSuccessCount++;
                                } else {
                                    const identifier = (result.node_name && result.node_name.includes('_') && result.node_name.split('_').length >= 3) ? 
                                        `(${result.node_name.split('_').slice(-2).join('/')})` : 
                                        '';
                                    pdfFailedFiles.push(`${result.node_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'} ${identifier}`);
                                }
                            }
                        });
                    }

                    summaryList.innerHTML = `
                        <li><span class="status-icon success-icon">‚úî</span> <b>CSV:</b> Export‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${csvSuccessCount} ‡πÑ‡∏ü‡∏•‡πå</li>
                        <li><span class="status-icon success-icon">‚úî</span> <b>PDF:</b> Export‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${pdfSuccessCount} ‡πÑ‡∏ü‡∏•‡πå</li>
                    `;
                    
                    if (skipCount > 0) {
                        const skipItem = document.createElement('li');
                        skipItem.innerHTML = `<span class="status-icon warning-icon">‚ö†</span> <b>‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•:</b> ${skipCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (NodeID/Interface ID ‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)`;
                        summaryList.appendChild(skipItem);
                    }

                    if (csvFailedFiles.length > 0) {
                        const csvFailedItem = document.createElement('li');
                        csvFailedItem.innerHTML = `<span class="status-icon failure-icon">‚úò</span> <b>CSV:</b> Export‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${csvFailedFiles.length} ‡πÑ‡∏ü‡∏•‡πå`;
                        summaryList.appendChild(csvFailedItem);
                        
                        const failedList = document.createElement('ul');
                        failedList.style.fontSize = '0.9em';
                        failedList.style.marginLeft = '20px';
                        csvFailedFiles.forEach(fileName => {
                            const listItem = document.createElement('li');
                            listItem.textContent = fileName;
                            failedList.appendChild(listItem);
                        });
                        summaryList.appendChild(failedList);
                    }

                    if (pdfFailedFiles.length > 0) {
                        const pdfFailedItem = document.createElement('li');
                        pdfFailedItem.innerHTML = `<span class="status-icon failure-icon">‚úò</span> <b>PDF:</b> Export‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${pdfFailedFiles.length} ‡πÑ‡∏ü‡∏•‡πå`;
                        summaryList.appendChild(pdfFailedItem);
                        
                        const failedList = document.createElement('ul');
                        failedList.style.fontSize = '0.9em';
                        failedList.style.marginLeft = '20px';
                        pdfFailedFiles.forEach(fileName => {
                            const listItem = document.createElement('li');
                            listItem.textContent = fileName;
                            failedList.appendChild(listItem);
                        });
                        summaryList.appendChild(failedList);
                    }

                    resultsArea.style.display = 'block';
                }
            }
        } catch (error) {
            console.error("Error fetching status:", error);
            statusMessage.innerHTML = `‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${error.message}`;
            clearIntervals();
            submitButton.disabled = false;
            downloadButton.style.display = 'none';
        }
    }

    async function fetchLogs() {
        if (!currentJobId) return;
        try {
            const logResponse = await fetch(`/logs/${currentJobId}`); // API endpoint from original index.html
            const logData = await logResponse.json();
            if (logData.logs && logData.logs.length > 0) {
                // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° log ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô
                const existingLogMessages = new Set(Array.from(logArea.children).map(div => div.textContent));

                logData.logs.forEach(log => {
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ logEntry ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ã‡πâ‡∏≥
                    if (!existingLogMessages.has(log)) {
                        const logEntry = document.createElement('div');
                        logEntry.textContent = log; 

                        // Assign class based on log content for coloring
                        if (log.startsWith('‚úÖ')) {
                            logEntry.classList.add('log-success');
                        } else if (log.startsWith('‚ùå')) {
                            logEntry.classList.add('log-error');
                        } else if (log.startsWith('‚ö†Ô∏è') || log.startsWith('‚õî')) {
                            logEntry.classList.add('log-warning');
                        } else if (log.startsWith('üìä') || log.startsWith('‚ñ∂') || log.startsWith('üìÇ') || log.startsWith('üì•') || log.startsWith('üóëÔ∏è') || log.startsWith('üßπ') || log.startsWith('‚ú®') || log.startsWith('üìÅ')) {
                            logEntry.classList.add('log-info');
                        } else {
                            logEntry.classList.add('log-info'); // Default to info color
                        }
                        
                        logArea.appendChild(logEntry);
                        existingLogMessages.add(log); // ‡πÄ‡∏û‡∏¥‡πà‡∏° log ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô Set
                    }
                });
                logArea.scrollTop = logArea.scrollHeight; // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î
            }
        } catch (error) {
            console.error("Error fetching logs:", error);
            // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á error message ‡∏ö‡∏ô UI ‡∏ñ‡πâ‡∏≤‡∏î‡∏∂‡∏á log ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
        }
    }
</script>

</body>
</html>